<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTIMAX Chauffeurs - Trip Log</title>

    <!-- Latest Reliable Dependencies (2025) -->
    <script src="https://unpkg.com/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://unpkg.com/html2pdf.js@0.10.2/dist/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/@html5-qrcode/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0d47a1; --red: #d32f2f; --green: #2e7d32; }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Roboto', sans-serif; background: #f0f4f8; padding: 12px; line-height: 1.5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 12px 50px rgba(0,0,0,0.18); }
        
        header { background: var(--primary); color: white; padding: 28px; text-align: center; }
        h1 { margin: 0; font-size: 32px; font-weight: 700; letter-spacing: 0.5px; }
        .subtitle { font-size: 18px; opacity: 0.95; margin-top: 8px; }

        .form-body { padding: 30px; }
        .required { color: var(--red); }
        .label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 6px; }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 13.5px; }
        th, td { border: 1.8px solid #000; padding: 10px; text-align: center; vertical-align: middle; }
        th { background: var(--primary); color: white; font-weight: 600; }

        input, textarea, select {
            width: 100%; padding: 11px; border: 1.5px solid #444; border-radius: 6px;
            font-family: inherit; font-size: 15px; background: white;
        }
        input:focus, textarea:focus { outline: 3px solid var(--primary); border-color: var(--primary); }

        .row { display: flex; gap: 20px; flex-wrap: wrap; margin: 18px 0; }
        .col { flex: 1; min-width: 280px; }

        .radio-group { display: flex; flex-wrap: wrap; gap: 22px; margin: 14px 0; }
        .radio-item { display: flex; align-items: center; gap: 8px; font-size: 15px; }

        .signature-box {
            border: 3px dashed var(--primary); height: 150px; border-radius: 10px;
            background: #f8fbff; position: relative; touch-action: none;
        }
        .signature-box canvas { width: 100%; height: 100%; border-radius: 8px; }
        .clear-btn {
            position: absolute; bottom: 10px; right: 12px; background: white;
            padding: 8px 16px; border-radius: 6px; font-weight: bold; color: var(--red);
            cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 13px;
        }

        .scanner-box { border: 2px dashed #555; padding: 20px; border-radius: 12px; background: #f9f9f9; text-align: center; margin: 25px 0; }
        #qr-reader { width: 100%; max-width: 460px; margin: 15px auto; border-radius: 10px; overflow: hidden; }

        .btn {
            padding: 16px 36px; margin: 12px; border: none; border-radius: 10px;
            font-size: 18px; font-weight: 600; cursor: pointer; color: white;
            min-width: 220px; border-radius: 10px; transition: 0.3s;
        }
        .btn-success { background: var(--green); }
        .btn-primary { background: var(--primary); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

        .office-section {
            border: 6px double var(--red); background: #fff5f5; padding: 25px;
            margin-top: 50px; border-radius: 12px;
        }

        .alert { padding: 15px; margin: 20px 0; border-radius: 8px; font-weight: bold; }
        .alert-error { background: #ffebee; color: var(--red); border: 1px solid var(--red); }
        .alert-success { background: #e8f5e8; color: var(--green); border: 1px solid var(--green); }

        @media (max-width: 768px) {
            .row { flex-direction: column; }
            .btn { width: 100%; margin: 10px 0; }
        }

        @media print {
            body { background: white; padding: 0; }
            .no-print, .scanner-box, .clear-btn, .alert { display: none !important; }
            .signature-box { border: 2px solid #000; background: white; }
            input, textarea { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body>

<div class="container" id="printable-form">
    <header>
        <h1>ULTIMAX Chauffeurs Services</h1>
        <div style="margin: 15px 0;">
            <img src="src/logo.png" alt="ULTIMAX Logo" style="width: 90px; height: 90px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
        </div>
        <div class="subtitle">Driver Trip Log & Expense Claim Form</div>
    </header>

    <div class="form-body">
        <div id="alert-box"></div>

        <div style="text-align: right; margin-bottom: 25px;">
            <strong>Date <span class="required">*</span>:</strong>
            <input type="date" id="trip_date" required>
        </div>

        <strong>ENGAGEMENT TYPE <span class="required">*</span>:</strong>
        <div class="radio-group" id="engagement-group">
            <div class="radio-item"><input type="radio" name="engagement" value="Contract" id="e1" required><label for="e1">Contract</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Per Trip" id="e2"><label for="e2">Per Trip</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Driver Day" id="e3"><label for="e3">Driver Day</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Adhoc" id="e4"><label for="e4">Adhoc</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Non-Contract" id="e5"><label for="e5">Non-Contract</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Per Pax" id="e6"><label for="e6">Per Pax</label></div>
            <div class="radio-item"><input type="radio" name="engagement" value="Other" id="e7"><label for="e7">Other</label></div>
        </div>

        <!-- Improved Trip Details Table -->
        <div style="margin: 25px 0; overflow-x:auto;" class="no-print">
            <table style="min-width: 900px;">
                <thead>
                    <tr>
                        <th rowspan="2" style="width:60px;">Trip #</th>
                        <th rowspan="2">Time<br><small>(e.g. 06:30–08:15)</small></th>
                        <th rowspan="2">Pick-up Location</th>
                        <th rowspan="2">Drop-off Location</th>
                        <th rowspan="2">Passenger / Client Name</th>
                        <th rowspan="2" style="width:70px;">Pax</th>
                        <th rowspan="2" style="width:80px;">Kms<br>(optional)</th>
                        <th rowspan="2" style="width:70px;">Waiting<br>Time (hrs)</th>
                        <th colspan="2" style="background:#fff176;">TOLLS / PARKING</th>
                        <th rowspan="2" style="width:90px;">Amount<br>(K)</th>
                    </tr>
                    <tr>
                        <th style="width:100px; background:#fff176;">Description</th>
                        <th style="width:60px; background:#fff176;">Receipt<br>✓</th>
                    </tr>
                </thead>
                <tbody id="trip-rows">
                    <!-- Row 1 -->
                    <tr>
                        <td style="text-align:center; font-weight:bold;">1</td>
                        <td><input type="text" placeholder="06:30–08:15"></td>
                        <td><input type="text" placeholder="Airport Terminal"></td>
                        <td><input type="text" placeholder="Hilton Hotel"></td>
                        <td><input type="text" placeholder="Mr John Smith"></td>
                        <td><input type="number" min="1" value="1" style="width:60px;"></td>
                        <td><input type="number" min="0" step="0.1"></td>
                        <td><input type="number" min="0" step="0.1" value="0"></td>
                        <td><input type="text" placeholder="Airport parking"></td>
                        <td style="text-align:center;"><input type="checkbox"></td>
                        <td><input type="number" min="0" step="0.01" placeholder="0.00"></td>
                    </tr>
                    <!-- Rows 2–15 (auto-generated by JS below) -->
                </tbody>
                <tfoot>
                    <tr style="background:#e3f2fd; font-weight:bold;">
                        <td colspan="5" style="text-align:right;">TOTALS →</td>
                        <td id="total-pax" style="text-align:center;">1</td>
                        <td></td>
                        <td></td>
                        <td colspan="2" style="text-align:right;">Total Expenses</td>
                        <td id="total-expense">0.00</td>
                    </tr>
                </tfoot>
            </table>

            <div style="text-align:center; margin-top:15px;">
                <button type="button" class="btn btn-primary" onclick="addTripRow()" style="min-width:180px; padding:12px;">
                    + Add Another Trip
                </button>
            </div>
        </div>

        <!-- Summary totals that also show when printing -->
        <div style="margin:30px 0; padding:15px; background:#e8f5e8; border-radius:10px; font-weight:bold; font-size:16px;">
            Total Trips Today: <span id="print-total-trips">1</span> | 
            Total Passengers: <span id="print-total-pax">1</span> | 
            Total Claimable Expenses: K<span id="print-total-expense">0.00</span>
        </div>

        <div class="row">
            <div class="col"><span class="label">Booking Code</span><input type="text" id="booking_code"></div>
            <div class="col"><span class="label">Cost Code</span><input type="text" id="cost_code"></div>
            <div class="col"><span class="label">Dept/Name</span><input type="text" id="dept_name"></div>
        </div>

        <div class="row">
            <div class="col"><span class="label">Client Name</span><input type="text" id="client_name"></div>
            <div class="col"><span class="label">Requested By</span><input type="text" id="requested_by"></div>
        </div>

        <!-- Client Signature -->
        <div style="margin: 35px 0;">
            <strong>CLIENT / AGENT SIGNATURE</strong>
            <div class="row">
                <div class="col">
                    <span class="label">Signature <span class="required">*</span></span>
                    <div class="signature-box"><canvas id="client_sig"></canvas><span class="clear-btn" onclick="clientPad.clear()">Clear</span></div>
                </div>
                <div class="col"><span class="label">Date</span><input type="date" id="client_date"></div>
            </div>
        </div>

        <!-- Driver Section -->
        <div style="margin: 40px 0;">
            <strong style="font-size: 20px;">DRIVER DECLARATION <span class="required">*</span></strong>
            <div class="row">
                <div class="col"><span class="label">Driver Name <span class="required">*</span></span><input type="text" id="driver_name" required></div>
                <div class="col"><span class="label">Date <span class="required">*</span></span><input type="date" id="driver_date" required></div>
            </div>
            <span class="label">Driver Signature <span class="required">*</span></span>
            <div class="signature-box"><canvas id="driver_sig"></canvas><span class="clear-btn" onclick="driverPad.clear()">Clear</span></div>
        </div>

        <!-- Office Use -->
        <div class="office-section">
            <strong style="font-size: 20px; color: var(--red);">OFFICE / ACCOUNTS USE ONLY</strong>
            <div class="row">
                <div class="col">
                    <span class="label">Coordinator Signature</span>
                    <div class="signature-box"><canvas id="office_sig"></canvas><span class="clear-btn" onclick="officePad.clear()">Clear</span></div>
                </div>
                <div class="col"><span class="label">Date Processed</span><input type="date" id="office_date"></div>
            </div>
        </div>

        <!-- QR Scanner -->
        <div class="scanner-box no-print">
            <strong>Scan QR / Barcode (Booking ID or Docket)</strong>
            <div id="qr-reader"></div>
            <div id="qr-result" style="margin-top:15px; font-weight:bold; color:var(--green);"></div>
        </div>

        <!-- Action Buttons -->
        <div style="text-align:center; margin:50px 0;" class="no-print">
            <button class="btn btn-success" onclick="downloadPDF()">Download PDF</button>
            <button class="btn btn-primary" onclick="submitWithEmail()">Submit + Email PDF</button>
        </div>
    </div>
</div>

<script>
    // Signature Pads
    const clientPad = new SignaturePad(document.getElementById('client_sig'), {penColor: "black"});
    const driverPad = new SignaturePad(document.getElementById('driver_sig'), {penColor: "black"});
    const officePad = new SignaturePad(document.getElementById('office_sig'), {penColor: "black"});

    function resizeCanvas(canvas) {
        if (!canvas) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }
    window.onresize = () => {
        [clientPad, driverPad, officePad].forEach(pad => {
            const data = pad.toDataURL();
            resizeCanvas(pad.canvas);
            pad.fromDataURL(data);
        });
    };
    [clientPad, driverPad, officePad].forEach(pad => resizeCanvas(pad.canvas));

    // QR Scanner
    const html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
        (text) => {
            document.getElementById('qr-result').textContent = "Scanned: " + text;
            document.getElementById('booking_code').value = text;
            setTimeout(() => html5QrCode.stop(), 2000);
        },
        () => {}
    ).catch(() => {});

    // Validation & Alerts
    function showAlert(message, type = 'error') {
        const box = document.getElementById('alert-box');
        box.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        box.scrollIntoView({ behavior: 'smooth' });
        setTimeout(() => box.innerHTML = '', 8000);
    }

    function validateForm() {
        const required = [
            { id: 'trip_date', name: 'Trip Date' },
            { id: 'driver_name', name: 'Driver Name' },
            { id: 'driver_date', name: 'Driver Date' },
        ];

        for (let field of required) {
            const el = document.getElementById(field.id);
            if (!el.value.trim()) {
                showAlert(`Please fill: ${field.name}`, 'error');
                el.focus();
                return false;
            }
        }

        if (driverPad.isEmpty()) {
            showAlert('Driver signature is required!', 'error');
            return false;
        }

        if (!document.querySelector('input[name="engagement"]:checked')) {
            showAlert('Please select Engagement Type', 'error');
            return false;
        }

        return true;
    }

    // Add Trip Row Function
    function addTripRow() {
        const tbody = document.getElementById('trip-rows');
        const rowCount = tbody.querySelectorAll('tr').length + 1;
        
        if (rowCount > 15) {
            showAlert('Maximum 15 trips allowed per form', 'error');
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td style="text-align:center; font-weight:bold;">${rowCount}</td>
            <td><input type="text" placeholder="06:30–08:15"></td>
            <td><input type="text" placeholder="Airport Terminal"></td>
            <td><input type="text" placeholder="Hilton Hotel"></td>
            <td><input type="text" placeholder="Mr John Smith"></td>
            <td><input type="number" min="1" value="1" style="width:60px;"></td>
            <td><input type="number" min="0" step="0.1"></td>
            <td><input type="number" min="0" step="0.1" value="0"></td>
            <td><input type="text" placeholder="Airport parking"></td>
            <td style="text-align:center;"><input type="checkbox"></td>
            <td><input type="number" min="0" step="0.01" placeholder="0.00"></td>
        `;
        
        tbody.appendChild(newRow);
        updateTripTotals();
    }

    // Update Trip Totals Function
    function updateTripTotals() {
        const tbody = document.getElementById('trip-rows');
        const rows = tbody.querySelectorAll('tr');
        let totalPax = 0;
        let totalExpense = 0;

        rows.forEach(row => {
            const paxInput = row.querySelector('td:nth-child(6) input');
            const expenseInput = row.querySelector('td:nth-child(11) input');
            
            if (paxInput && paxInput.value) {
                totalPax += parseInt(paxInput.value) || 0;
            }
            if (expenseInput && expenseInput.value) {
                totalExpense += parseFloat(expenseInput.value) || 0;
            }
        });

        document.getElementById('total-pax').textContent = totalPax || '0';
        document.getElementById('total-expense').textContent = totalExpense.toFixed(2);
        document.getElementById('print-total-trips').textContent = rows.length;
        document.getElementById('print-total-pax').textContent = totalPax || '0';
        document.getElementById('print-total-expense').textContent = totalExpense.toFixed(2);
    }

    // Add event listeners to update totals when inputs change
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('trip-rows');
        tbody.addEventListener('input', updateTripTotals);
    });

    // Download PDF
    function downloadPDF() {
        if (!validateForm()) return;

        const opt = {
            margin: 10,
            filename: `ULTIMAX_TripLog_${document.getElementById('trip_date').value || 'Draft'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(document.getElementById('printable-form')).save();
        showAlert('PDF downloaded successfully!', 'success');
    }

    // Submit via Email (Formspree)
    async function submitWithEmail() {
        if (!validateForm()) return;

        showAlert('Generating PDF and sending email...', 'success');

        const element = document.getElementById('printable-form');
        const opt = {
            margin: 10,
            filename: 'trip-log.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');

        const formData = new FormData();
        formData.append('pdf', pdfBlob, `ULTIMAX_TripLog_${new Date().toISOString().slice(0,10)}.pdf`);
        formData.append('driver_name', document.getElementById('driver_name').value);
        formData.append('trip_date', document.getElementById('trip_date').value);
        formData.append('booking_code', document.getElementById('booking_code').value || 'N/A');
        formData.append('submission_time', new Date().toLocaleString());

        fetch('https://formspree.io/f/xqarlrby', {  // ← CHANGE THIS TO YOUR FORMSPREE ENDPOINT
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        })
        .then(() => {
            showAlert('Form submitted successfully! PDF sent to office.', 'success');
        })
        .catch(() => {
            showAlert('Email failed. But you can still download the PDF.', 'error');
        });
    }
</script>

</body>
</html>